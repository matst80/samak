<html>
<head>
	<script src="userdata.js"></script>
	<script type="text/javascript" src="http://www.google.com/jsapi"></script>
</head>
<body>
	<section>
<div id="map" style="width:100%;height:100%"></div>
	</section>
<section class="view profile">
	<div id="userdata">laddar...</div>
	<img id="profilepic" alt="profilbild" />
</section>
<section class="view search">
	<label for="from">Från</label>
	<input id="from" />
	<label for="to">Till</label>
	<input id="to" />
	<span class="button disabled" id="addroute">Lägg till</span>
</section>
<script>
	function initialize()
	{

		var addbutton = document.getElementById('addroute');
		var from = document.getElementById('from');
		var to = document.getElementById('to');

		var directionsService = new google.maps.DirectionsService();
		var directionsDisplay = new google.maps.DirectionsRenderer()
		
		function updatePos(lng,lat)
		{
			var latlng = new google.maps.LatLng(lat, lng);
        	map.panTo(latlng);
        	geocoder.geocode({'latLng': latlng}, function(results, status) {
	            if(status == google.maps.GeocoderStatus.OK) {
                	console.log(results[0]);
                	document.getElementById('from').value = results[0]["formatted_address"];
            	};
        	});
		}
		var currentRoute = {};
		var mapOptions = {
          center: new google.maps.LatLng(60.604819,15.6656285),
          zoom: 12
        };
        
        var map = new google.maps.Map(document.getElementById("map"), mapOptions);
		directionsDisplay.setMap(map);

		function calcRoute() {
			currentRoute = {};
			addbutton.className = 'button disabled';
			var start = document.getElementById('from').value;
			var end = document.getElementById('to').value;
			var request = {
			    origin:start,
			    destination:end,
			    travelMode: google.maps.TravelMode.DRIVING
			};
			directionsService.route(request, function(response, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					addbutton.className = 'button';
					currentRoute = response.routes[0];
			    	directionsDisplay.setDirections(response);
			    }
			});
		}

		function addRoute()
		{
			console.log(currentRoute);
		}

		document.getElementById('to').addEventListener('change',calcRoute,false);
		addbutton.addEventListener('click',addRoute,false);

		function getLocation()
		{
			function showPosition(position)
		  	{
		  		console.log(position);
		  		updatePos(position.coords.longitude,position.coords.latitude);
		  	}
			if (navigator.geolocation)
		    {
		    	navigator.geolocation.getCurrentPosition(showPosition);
		    }
		}
		getLocation();
		
		
    	var geocoder = new google.maps.Geocoder();
    	if(google.loader.ClientLocation) {
	        var lat = google.loader.ClientLocation.latitude;
        	var lng = google.loader.ClientLocation.longitude;
        	updatePos(lng,lat);
        	
    	}

	}

	google.load("maps", "3.x", {other_params: "sensor=false", callback:initialize});
	document.getElementById('userdata').innerHTML = userdata.displayName;
	document.getElementById('profilepic').src = 'https://graph.facebook.com/'+userdata.username+'/picture';
</script>
</body>
</html>