<html>
<head>
	<link rel="stylesheet" href="css/style.css" type="text/css" />
	<script src="userdata.js"></script>
	<script type="text/javascript" src="http://www.google.com/jsapi"></script>
	<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1-beta1.js"></script>
</head>
<body>
	<section>
<div id="map" style="width:100%;height:100%"></div>
	</section>
<section class="view profile">
	<div id="userdata">laddar...</div>
	<img id="profilepic" alt="profilbild" />
</section>
<section class="view add">
	<label for="from">Från:</label>
	<input id="from" />
	<label for="to">Till:</label>
	<input id="to" />
	<label for="to">Åker:</label>
	<input id="startdate" type="date" />
	<input id="starttime" type="time" />
	<span class="button disabled" id="addroute">Lägg till</span>
</section>
<section class="view routelist">
	<ul id="routelist">
	</ul>
</section>
<script>


	Date.prototype.toSqlString = function() {
		var d1=this;

        var curr_year = d1.getFullYear();

        var curr_month = d1.getMonth() + 1; //Months are zero based
        if (curr_month < 10)
            curr_month = "0" + curr_month;

        var curr_date = d1.getDate();
        if (curr_date < 10)
            curr_date = "0" + curr_date;

        var curr_hour = d1.getHours();
        if (curr_hour < 10)
            curr_hour = "0" + curr_hour;

        var curr_min = d1.getMinutes();
        if (curr_min < 10)
            curr_min = "0" + curr_min;

        var curr_sec = d1.getSeconds();     
        if (curr_sec < 10)
            curr_sec = "0" + curr_sec;

        return curr_year + "-" + curr_month + "-" + curr_date + " " + curr_hour + ":" + curr_min + ":" + curr_sec;
	}
	
	var now = new Date();


	function initialize()
	{

		var addbutton = document.getElementById('addroute');
		var from = document.getElementById('from');
		var to = document.getElementById('to');
		var routes = document.getElementById('routelist');
		var startdate = document.getElementById('startdate');
		var starttime = document.getElementById('starttime');

		var directionsService = new google.maps.DirectionsService();
		var directionsDisplay = new google.maps.DirectionsRenderer();

		$.getJSON('/api/routes',function(d) {
			console.log(d,d.length);
			for(var i=0;i<d.length;i++)
			{
				var r = d[i];
				var li = document.createElement('li');
				li.innerHTML = '<span>'+r.start+'</span> - <span>'+r.end+'</span>';
				routes.appendChild(li);
			}
		});
		
		function updatePos(lng,lat)
		{
			var latlng = new google.maps.LatLng(lat, lng);
        	map.panTo(latlng);
        	geocoder.geocode({'latLng': latlng}, function(results, status) {
	            if(status == google.maps.GeocoderStatus.OK) {
                	console.log(results[0]);
                	document.getElementById('from').value = results[0]["formatted_address"];
            	};
        	});
		}
		var currentRoute = {};
		var mapOptions = {
          center: new google.maps.LatLng(60.604819,15.6656285),
          zoom: 12
        };
        
        var map = new google.maps.Map(document.getElementById("map"), mapOptions);
		directionsDisplay.setMap(map);

		function calcRoute() {
			currentRoute = {};
			addbutton.className = 'button disabled';
			var start = document.getElementById('from').value;
			var end = document.getElementById('to').value;
			var request = {
			    origin:start,
			    destination:end,
			    travelMode: google.maps.TravelMode.DRIVING
			};
			directionsService.route(request, function(response, status) {
				if (status == google.maps.DirectionsStatus.OK) {
					addbutton.className = 'button';
					currentRoute = response.routes[0];
			    	directionsDisplay.setDirections(response);
			    }
			});
		}

		function addRoute()
		{
			
			var l = currentRoute.legs[0];
			console.log(l);
			var route = {
				distance: l.distance.value,
				duration: l.duration.value,
				starttime: now.toSqlString(),
				end: l.end_address,
				start: l.start_address,
				startlat: l.start_location.lat(),
				startlng: l.start_location.lng(),
				endlat: l.end_location.lat(),
				endlng: l.end_location.lng(),
			};
			console.log(route);
			$.post('/api/route/add',route,function(d) {
				console.log(d);
			});
		}

		document.getElementById('to').addEventListener('change',calcRoute,false);
		addbutton.addEventListener('click',addRoute,false);

		function getLocation()
		{
			function showPosition(position)
		  	{
		  		console.log(position);
		  		updatePos(position.coords.longitude,position.coords.latitude);
		  	}
			if (navigator.geolocation)
		    {
		    	navigator.geolocation.getCurrentPosition(showPosition);
		    }
		}
		getLocation();
		
		
    	var geocoder = new google.maps.Geocoder();
    	if(google.loader.ClientLocation) {
	        var lat = google.loader.ClientLocation.latitude;
        	var lng = google.loader.ClientLocation.longitude;
        	updatePos(lng,lat);
        	
    	}

	}

	google.load("maps", "3.x", {other_params: "sensor=false", callback:initialize});
	document.getElementById('userdata').innerHTML = userdata.displayName;
	document.getElementById('profilepic').src = 'https://graph.facebook.com/'+userdata.username+'/picture';
</script>
</body>
</html>
